<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
	</head>
	<body>
		<div id="results"></div>
		<script type="text/javascript">
			(function() {
				var radius = 200
				var apiUser = "mioslabs"
				var apiPass = "kaakaa"
				var apiUrl = "api.asp"
				var parseTime = function(time) {
					return time.length==3?
						"0"+time.substring(0,1)+":"+time.substring(1,3):
						time.substring(0,2)+":"+time.substring(2,4)
				}
				var ajaxError = function(message) {
					return function(request,status) {
						error(message);
						console.error("Details", status, request.responseText)
					}
				}
				var error = function(message) {
					return function() { 
						error(message);
					}
				}
				var receivedSchedule = function(data) {
					var lines = data.split("\n")
					var header = lines[0].split("|");
					message("Found stop",header[1],"at",header[2],header[3],"with",lines.length-1,"entries");
					var list;
					$("#results").append(
						$("<div>").append(
							$("<h3>")
								.text(header[1])
								.append(" ",$("<small>").text("(at "+header[2]+" in "+header[3]+")")
							),
							$("<p>").append(
								"Destinations: ",
								destinations = $("<span>")
							),
							list = $("<ul>")
						)
					)
					var destinationsFound = {}
					lines.slice(1,lines.length-1).map(function(line){
						line = line.split("|")
						list.append(
							$("<li>").append(
								$("<em>").text(parseTime(line[0])),
								" line ",
								$("<strong>").text(line[1]),
								" to "+line[2]
							)
						)
						if(!destinationsFound[line[2]]) {
							destinationsFound[line[2]] = true;
							destinations.append(line[2]+" ")
						}
					})
				}
				var receivedStops = function(data) {
					var stops = $(data).find("[code]");
					if(stops.length==0) {
						message("No stops found within a",radius,"meter radius")
						return
					}
					message("Requesting schedule(s) for",stops.length,"stop(s)")
					stops.map(function(i,e){ 
						var code = e.getAttribute("code")
						requestSchedule(code,receivedSchedule)
					})
				}
				var positionUpdated = function(position) {
					$("#results").empty();
					message("At ",position.coords.latitude,"(lat)",position.coords.longitude+"(lng)")
					message("Requesting stops");
					requestStops(position,receivedStops)
				}
				function requestStops(position,success) {
					$.ajax({ 
						url: apiUrl,
						data: {
							"closest_stops": "1",
							"lon": position.coords.longitude, 
							"lat": position.coords.latitude,
							"radius": radius,
							"user": apiUser, "pass": apiPass
						}, 
						success: success,
						error: ajaxError("Unable to retrieve stops")
					});
				}
				function requestSchedule(code,success) {
					$.ajax({
						url: apiUrl, 
						data: { "stop": code, user: apiUser, pass: apiPass }, 
						success: success,
						error: ajaxError("Unable to retrieve schedule for stop "+code)
					})
				}
				function error() {
					console.error(arguments)
					$(body).append("Error: "+arguments.join(" "))
				}
				function message() {
					console.log(arguments)
					$(document.body).append("<div>Message: "+Array.prototype.slice.call(arguments).join(" ")+"</div>")
				}
				
				var gl = navigator.geolocation
				if(!gl) {
					error("Geolocation service unavailable");
					return;
				}
				message("Requesting position");
				gl.getCurrentPosition(
					positionUpdated,
					function(error) {
						error("Unable to get position",error);
					}, { timeout: 2000 }
				);
			})();
		</script>
	</body>
</html>