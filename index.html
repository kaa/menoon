<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
	</head>
	<body>
		<div id="results"></div>
		<script type="text/javascript">
			function error() {
				console.error(arguments)
				$(document.body).append("Error: "+Array.prototype.slice.call(arguments).join(" "))
			}
			function message() {
				console.log(arguments)
				$(document.body).append("<div>Message: "+Array.prototype.slice.call(arguments).join(" ")+"</div>")
			}
			function keys(hash) {
				var found = []
				for( var k in hash ) found.push(k);
				return found;
			}
			function fixName(name) {
				return name.replace(/\w\(/," (")
			}

			(function() {
				var radius = 200
				var apiUser = "mioslabs"
				var apiPass = "kaakaa"
				var apiUrl = "api.asp"
				var elements = {}

				initialize();

				function initialize() {
					var gl = navigator.geolocation
					if(!gl) {
						error("Geolocation service unavailable")
						return
					}
					message("Requesting position");
					gl.getCurrentPosition(
						positionUpdated,
						function(error) {
							error("Unable to get position",error)
						}, { timeout: 2000 }
					)
				}

				function positionUpdated(position) {
					$("#results").empty();
					message("At ",position.coords.latitude,"(lat)",position.coords.longitude+"(lng)")
					message("Requesting stops");
					requestStops(position,receivedStops)
				}

				function requestStops(position,success) {
					$.ajax({ 
						url: apiUrl,
						data: {
							"closest_stops": "1",
							"lat": position.coords.latitude,
							"lon": position.coords.longitude, 
							"radius": radius,
							"user": apiUser, "pass": apiPass
						}, 
						success: function(data) {
							success($(data)
								.find("[code]")
								.map(function(i,e){ 
									return {
										code: e.getAttribute("code"),
										lat: Number(e.getAttribute("lat")),
										lng: Number(e.getAttribute("lon")),
										distance: Number(e.getAttribute("dist"))
									}
								})
							)
						},
						error: function(request,status) {
							error("Unable to retrieve stops");
							console.error("Details", status, request.responseText)
						}
					});
				}

				function receivedStops(stops) {
					if(stops.length==0) {
						message("No stops found within a",radius,"meter radius")
						return
					}
					message("Requesting schedule(s) for",stops.length,"stop(s)")
					stops.map(function(i,stop){ 
						requestStop(stop,displayStop)
					})
				}

				function requestStop(stop,success) {
					$.ajax({
						url: apiUrl, 
						data: { "stop": stop.code, user: apiUser, pass: apiPass }, 
						success: function(data) {
							var lines = data.split("\n")
							var header = lines[0].split("|")
							stop.name = header[1]
							stop.address = header[2]
							stop.city = header[3]
							stop.schedule = lines
								.slice(1,lines.length-1)
								.map(parseScheduleLine)
							success(stop)
						},
						error: function(request,status) {
							error("Unable to retrieve schedule for stop "+code);
							console.error("Details", status, request.responseText)
						}
					})
				}
				function parseScheduleLine(line) {
					line = line.split("|")
					return {
						time: line[0].length==3?
							"0"+line[0].substring(0,1)+":"+line[0].substring(1,3):
							line[0].substring(0,2)+":"+line[0].substring(2,4),
						line: line[1],
						destination: line[2],
						code: line[3]
					}
				}

				function displayStop(stop) {
					var element = elements[stop.code]
					if(!element) {
						element = $(
							"<div>"+
								"<h3><span></span> <small></small></h3>"+
								"<p>Line(s) <strong class=\"lines\"></strong> "+
								"Destination(s) <strong class=\"destinations\"></strong></p>"+
								"<ul></ul>"+
							"</div>")
						elements[stop.code] = element
						$("#results").append(element)
					}
					if(stop.schedule.length==0) {
						element.remove()
						delete elements[stop.code]
						return
					}
					message("Update for stop",stop.code," with ",stop.schedule.length,"entries")
					var destinations = {}, lines = {};
					stop.schedule.map(function(entry){
						destinations[fixName(entry.destination)] = true
						lines[entry.line] = true
					})
					element.find("h3 span")
						.text(fixName(stop.name))
					element.find("h3 small")
						.text("("+stop.address+" in "+stop.city+", "+stop.distance+"m)")
					element.find("p strong.lines")
						.text(keys(lines).join(", "))
					element.find("p strong.destinations")
						.text(keys(destinations).join(", "))

					var list = element.find("ul").empty()
					stop.schedule.map(function(entry) {
						list.append(createScheduleEntry(entry))
					})
				}
				function createScheduleEntry(entry) {
					return $("<li>").append(
						$("<em>").text(entry.time),
						" line ",
						$("<strong>").text(entry.line),
						" to "+entry.destination
					)
				}
			})();
		</script>
	</body>
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-20530172-1']);
		_gaq.push(['_trackPageview']);
		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>
</html>