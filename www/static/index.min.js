(function(a){a.jGrowl=function(b,c){if(a("#jGrowl").size()==0)a('<div id="jGrowl"></div>').addClass(c&&c.position?c.position:a.jGrowl.defaults.position).appendTo("body");a("#jGrowl").jGrowl(b,c)};a.fn.jGrowl=function(b,c){if(a.isFunction(this.each)){var e=arguments;return this.each(function(){if(a(this).data("jGrowl.instance")==undefined){a(this).data("jGrowl.instance",a.extend(new a.fn.jGrowl,{notifications:[],element:null,interval:null}));a(this).data("jGrowl.instance").startup(this)}a.isFunction(a(this).data("jGrowl.instance")[b])?
a(this).data("jGrowl.instance")[b].apply(a(this).data("jGrowl.instance"),a.makeArray(e).slice(1)):a(this).data("jGrowl.instance").create(b,c)})}};a.extend(a.fn.jGrowl.prototype,{defaults:{pool:0,header:"",group:"",sticky:false,position:"top-right",glue:"after",theme:"default",themeState:"highlight",corners:"10px",check:250,life:3E3,closeDuration:"normal",openDuration:"normal",easing:"swing",closer:true,closeTemplate:"&times;",closerTemplate:"<div>[ close all ]</div>",log:function(){},beforeOpen:function(){},
afterOpen:function(){},open:function(){},beforeClose:function(){},close:function(){},animateOpen:{opacity:"show"},animateClose:{opacity:"hide"}},notifications:[],element:null,interval:null,create:function(b,c){c=a.extend({},this.defaults,c);if(typeof c.speed!=="undefined"){c.openDuration=c.speed;c.closeDuration=c.speed}this.notifications.push({message:b,options:c});c.log.apply(this.element,[this.element,b,c]);this.update()},render:function(b){var c=this,e=b.message,d=b.options;b=a('<div class="jGrowl-notification '+
d.themeState+" ui-corner-all"+(d.group!=undefined&&d.group!=""?" "+d.group:"")+'"><div class="jGrowl-close">'+d.closeTemplate+'</div><div class="jGrowl-header">'+d.header+'</div><div class="jGrowl-message">'+e+"</div></div>").data("jGrowl",d).addClass(d.theme).children("div.jGrowl-close").bind("click.jGrowl",function(){a(this).parent().trigger("jGrowl.close")}).parent();a(b).bind("mouseover.jGrowl",function(){a("div.jGrowl-notification",c.element).data("jGrowl.pause",true)}).bind("mouseout.jGrowl",
function(){a("div.jGrowl-notification",c.element).data("jGrowl.pause",false)}).bind("jGrowl.beforeOpen",function(){d.beforeOpen.apply(b,[b,e,d,c.element])!=false&&a(this).trigger("jGrowl.open")}).bind("jGrowl.open",function(){if(d.open.apply(b,[b,e,d,c.element])!=false){d.glue=="after"?a("div.jGrowl-notification:last",c.element).after(b):a("div.jGrowl-notification:first",c.element).before(b);a(this).animate(d.animateOpen,d.openDuration,d.easing,function(){if(a.browser.msie&&(parseInt(a(this).css("opacity"),
10)===1||parseInt(a(this).css("opacity"),10)===0))this.style.removeAttribute("filter");a(this).data("jGrowl").created=new Date;a(this).trigger("jGrowl.afterOpen")})}}).bind("jGrowl.afterOpen",function(){d.afterOpen.apply(b,[b,e,d,c.element])}).bind("jGrowl.beforeClose",function(){d.beforeClose.apply(b,[b,e,d,c.element])!=false&&a(this).trigger("jGrowl.close")}).bind("jGrowl.close",function(){a(this).data("jGrowl.pause",true);a(this).animate(d.animateClose,d.closeDuration,d.easing,function(){a(this).remove();
var f=d.close.apply(b,[b,e,d,c.element]);a.isFunction(f)&&f.apply(b,[b,e,d,c.element])})}).trigger("jGrowl.beforeOpen");d.corners!=""&&a.fn.corner!=undefined&&a(b).corner(d.corners);a("div.jGrowl-notification:parent",c.element).size()>1&&a("div.jGrowl-closer",c.element).size()==0&&this.defaults.closer!=false&&a(this.defaults.closerTemplate).addClass("jGrowl-closer ui-state-highlight ui-corner-all").addClass(this.defaults.theme).appendTo(c.element).animate(this.defaults.animateOpen,this.defaults.speed,
this.defaults.easing).bind("click.jGrowl",function(){a(this).siblings().trigger("jGrowl.beforeClose");a.isFunction(c.defaults.closer)&&c.defaults.closer.apply(a(this).parent()[0],[a(this).parent()[0]])})},update:function(){a(this.element).find("div.jGrowl-notification:parent").each(function(){if(a(this).data("jGrowl")!=undefined&&a(this).data("jGrowl").created!=undefined&&a(this).data("jGrowl").created.getTime()+parseInt(a(this).data("jGrowl").life)<(new Date).getTime()&&a(this).data("jGrowl").sticky!=
true&&(a(this).data("jGrowl.pause")==undefined||a(this).data("jGrowl.pause")!=true))a(this).trigger("jGrowl.beforeClose")});if(this.notifications.length>0&&(this.defaults.pool==0||a(this.element).find("div.jGrowl-notification:parent").size()<this.defaults.pool))this.render(this.notifications.shift());a(this.element).find("div.jGrowl-notification:parent").size()<2&&a(this.element).find("div.jGrowl-closer").animate(this.defaults.animateClose,this.defaults.speed,this.defaults.easing,function(){a(this).remove()})},
startup:function(b){this.element=a(b).addClass("jGrowl").append('<div class="jGrowl-notification"></div>');this.interval=setInterval(function(){a(b).data("jGrowl.instance").update()},parseInt(this.defaults.check));a.browser.msie&&parseInt(a.browser.version)<7&&!window.XMLHttpRequest&&a(this.element).addClass("ie6")},shutdown:function(){a(this.element).removeClass("jGrowl").find("div.jGrowl-notification").remove();clearInterval(this.interval)},close:function(){a(this.element).find("div.jGrowl-notification").each(function(){a(this).trigger("jGrowl.beforeClose")})}});
a.jGrowl.defaults=a.fn.jGrowl.prototype.defaults})(jQuery);(function(a){a.fn.fixHeight=function(){this.bind("orientationchange resize pageshow ready",function(){scroll(0,0);var b=a(this).find(".ui-content"),c=a(this).height()-a(this).find(".ui-header").outerHeight()-a(this).find(".ui-footer").outerHeight()-(b.outerHeight()-b.height());b.height(c);c=jQuery.Event("resize");c.stopPropagation();b.trigger(c)});return this}})(jQuery);
function QueryString(a){var b=this;a.replace(/^\?/,"").split("&").map(function(c){c=c.split("=");b[c[0]]=c[1]})}EventTarget={addEventListener:function(a,b){this.listeners=this.listeners||{};this.listeners[a]=this.listeners[a]||[];this.listeners[a].push(b)},removeEventListener:function(a,b){var c=this.listeners[a];if(c)for(var e=0;e<c.length;e++)c[e]==b&&delete c[e]},dispatchEvent:function(a){a.currentTarget=this;var b=(this.listeners||{})[a.type];b&&b.map(function(c){c(a)})}};
function ReittiopasApi(a){this.apiUrl=a}ReittiopasApi.prototype.findStops=function(a,b,c){$.ajax({url:this.apiUrl,data:{closest_stops:"1",lat:a.latitude,lon:a.longitude,radius:b},success:function(e){c($.makeArray($(e).find("[code]").map(function(d,f){return{code:f.getAttribute("code"),lat:Number(f.getAttribute("lat")),lng:Number(f.getAttribute("lon")),distance:Number(f.getAttribute("dist"))}})))},error:function(e,d){Log.error("Unable to retrieve stops");console.log("Details",d,e.responseText)}})};
ReittiopasApi.prototype.getSchedule=function(a,b){$.ajax({url:this.apiUrl,data:{stop:a.code},success:function(c){c=c.split("\n");var e=c[0].split("|");a.name=e[1];a.address=e[2];a.city=e[3];a.schedule=c.slice(1,c.length-1).map(ReittiopasApi.parseScheduleLine);b(a)},error:function(c,e){Log.error("Unable to retrieve schedule for stop "+code);console.log("Details",e,c.responseText)}})};
ReittiopasApi.parseScheduleLine=function(a){a=a.split("|");return{time:ReittiopasApi.parseTime(a[0]),line:a[1],code:a[3],destination:a[2].replace(/(\w)?\(/,function(b,c){return c?c+" (":b})}};ReittiopasApi.parseTime=function(a){var b=(new Date).getTime();b-=b%864E5-(new Date).getTimezoneOffset()*60*1E3;b+=a.length==3?parseInt(a.substring(0,1))*60*60*1E3+parseInt(a.substring(1,3))*60*1E3:parseInt(a.substring(0,2))*60*60*1E3+parseInt(a.substring(2,4))*60*1E3;return new Date(b)};
function DummyApi(){}DummyApi.prototype.findStops=function(a,b,c){Log.verbose("Pretending to find stops near "+a.latitude+","+a.longitude+" in "+b+" m radius");c([{code:"1",distance:100,lat:"21.2",lng:"63.4"},{code:"2",distance:120,lat:"21.3",lng:"63.2"},{code:"3",distance:150,lat:"21.3",lng:"63.2"},{code:"4",distance:175,lat:"21.3",lng:"63.2"},{code:"5",distance:176,lat:"21.3",lng:"63.2"}])};
DummyApi.prototype.getSchedule=function(a,b){Log.verbose("Pretending to find schedule for stop "+a.code);var c=(new Date).getTime();b($.extend(a,{"1":{code:"1",name:"Dummy metro",address:"Metro street 1",city:"Helsinki",schedule:[{time:new Date(c+6E4),line:"metro",destination:"Dummy ville",code:"1006  2"},{time:new Date(c+24E4),line:"metro",destination:"Dummy town",code:"1006  2"},{time:new Date(c+42E4),line:"metro",destination:"Dummy ville",code:"1006  2"},{time:new Date(c+54E4),line:"metro",destination:"Dummy town",
code:"1006  2"}]},"2":{code:"2",name:"Dummy tram stop",address:"Tram street 1",city:"Helsinki",schedule:[{time:new Date(c+24E4),line:"6",destination:"Dummy street",code:"1006  2"},{time:new Date(c+84E4),line:"6",destination:"Dummy street",code:"1006  2"},{time:new Date(c+144E4),line:"6",destination:"Dummy street",code:"1006  2"}]},"3":{code:"3",name:"Dummy bus",address:"Bus street 1",city:"Helsinki",schedule:[{time:new Date(c+24E4),line:"20",destination:"Dummy ville",code:"1006  2"},{time:new Date(c+
3E5),line:"20T",destination:"Dummy ville",code:"1006  2"}]},"4":{code:"4",name:"Dummy train",address:"Trainstation street 2",city:"Helsinki",schedule:[{time:new Date(c+24E4),line:"A",destination:"Dummy ville",code:"1006  2"},{time:new Date(c+3E5),line:"B",destination:"Dummy ville",code:"1006  2"}]},"5":{code:"5",name:"Dummy ferry",address:"Ferryterminal",city:"Helsinki",schedule:[{time:new Date(c+18E4),line:"lautta",destination:"Dummy ville",code:"1006  2"},{time:new Date(c+9E5),line:"lautta",destination:"Dummy ville",
code:"1006  2"}]}}[a.code]))};function Location(a,b){this.latitude=a;this.longitude=b}
$.extend(Location.prototype,{addGeocodingResult:function(a){if($.isArray(a))for(var b=0;b<a.length;b++)this.addGeocodingResult(a[b]);else if(a.address_components)this.addGeocodingResult(a.address_components);else if($.inArray("street_number",a.types)>=0)this.number=this.number||a.short_name;else if($.inArray("route",a.types)>=0)this.street=this.steet||a.long_name;else if($.inArray("locality",a.types)>=0)this.city=this.city||a.long_name;else if($.inArray("administrative_area_level_2",a.types)>=0)this.area=
this.area||a.long_name;else if($.inArray("country",a.types)>=0)this.country=this.country||a.long_name},toReadableString:function(){if(this.street)return this.street+(this.number?" "+this.number:"");if(this.city)return this.city;return this.latitude+" "+this.longitude}});function LocationEvent(a,b){this.type="location";this.status=b||this.SUCCESS;this.location=a}$.extend(LocationEvent.prototype,{SUCCESS:1,TIMEOUT:2,UNAVAILABLE:3,PERMISSION_DENIED:4});
function Log(a){console.log(a);Log.level=a||1;$.jGrowl.defaults.closer=false;$.jGrowl.defaults.closeTemplate=""}Log.error=function(){if(!(Log.level<1)){console.log(arguments);$.jGrowl(Array.prototype.slice.call(arguments).join(" "),{theme:"error"})}};Log.warn=function(){if(!(Log.level<2)){console.log(arguments);$.jGrowl(Array.prototype.slice.call(arguments).join(" "),{theme:"warn"})}};
Log.message=function(){if(!(Log.level<3)){console.log(arguments);$.jGrowl(Array.prototype.slice.call(arguments).join(" "),{theme:"message"})}};Log.verbose=function(){if(!(Log.level<4)){console.log(arguments);$.jGrowl(Array.prototype.slice.call(arguments).join(" "),{theme:"verbose"})}};
function Stop(){this.element=$('<li class="stop"><h3><span class="name">Unknown</span> <small><span class="address"></span> <span class="dir"></span></small></h3><p class="lines">Lines: <span><em>None</em></span></p><div class="imminent"></div><div class="schedule"></div></div>');var a=this;this.element.find(".imminent").click(function(){a.element.find(".schedule").toggleClass("open")})}
$.extend(Stop.prototype,{show:function(a){if(a.schedule.length==0)this.element.hide();else{this.displayDetails(a);this.displayDestinations(a.schedule);this.displayImminent(a.schedule);this.displaySchedule(a.schedule)}},displayDetails:function(a){var b=this;this.element.removeClass();this.element.addClass("stop");a.schedule.map(function(c){b.element.addClass(Stop.typeFromLine(c.line))});this.element.find("h3 .name").text(a.name||"Unknown");this.element.find("h3 .address").text((a.address||"?")+" in "+
(a.city||"?"));this.element.find("h3 .dir").text((a.distance||"?")+"m")},displayDestinations:function(a){var b={};a.map(function(d){var f=b[d.destination]||{};f[d.line]=true;b[d.destination]=f});var c=this.element.find(".lines span").empty(),e="";$.each(b,function(d,f){c.append(e);e=", ";var h="",g=$("<strong>");g.append(d+" (");$.each(f,function(i){g.append(h);h=", ";g.append($("<span>").text(i))});g.append(")");c.append(g)})},displaySchedule:function(a){var b=this.element.find(".schedule ul").empty();
a.filter(function(c){return c.time.getTime()>(new Date).getTime()}).slice(0,10).map(function(c){b.append($("<li>").append($("<strong>").text(c.time.toTimeString().substring(0,5))," "+Stop.typeFromLine(c.line)+" ",$("<strong>").text(c.line)," to ",$("<strong>").text(c.destination)))})},displayImminent:function(a){var b=this,c=this.element.find(".imminent").empty();a.filter(function(e){return e.time>new Date}).slice(0,2).map(function(e){var d=b.timeDiff(e.time);d=d.getHours()*60+d.getMinutes();c.append($('<div><span class="time '+
(d>99?"long":"")+'"><strong>'+d+' min</strong></span> <span class="departure">'+Stop.readableLine(e.line)+" at <strong>"+e.time.toTimeString().substring(0,5)+'</strong></span><span class="line">to '+e.destination+"</span> </div>"))})},timeDiff:function(a,b){var c=a.getTime()-(b||new Date).getTime();return new Date(0,0,0,c/1E3/60/60,c/1E3/60%60,c/1E3%60)}});
Stop.readableLine=function(a){switch(Stop.typeFromLine(a)){case "metro":return"Metro";case "ferry":return"Ferry";case "train":return a+"-train";case "tram":return"Tram "+a;case "bus":return"Bus "+a;default:return a}};Stop.typeFromLine=function(a){return a=="metro"?"metro":a=="lautta"?"ferry":a.match(/^[a-zA-Z]$/)?"train":a.match(/^(\d[A-Z]?|10)$/)?"tram":"bus"};
var Map=$.extend({},EventTarget,{initialize:function(a){this.options=$.extend({position:{latitude:60.1630215,longitude:24.9283883},radius:200},a);var b=this;this.parent().bind("resize",function(){console.log("resize");google.maps.event.trigger(b.map,"resize");b.circle&&b.map.setCenter(b.circle.getCenter())});this._initializeMap();return this},setLocation:function(a){this._focus(new google.maps.LatLng(a.latitude,a.longitude))},_mapClicked:function(a){this._focus(a.latLng);this.trigger(new LocationEvent(new Location(a.latLng.lat(),
a.latLng.lng())))},_focus:function(a){var b=this.circle;if(!b)this.circle=b=new google.maps.Circle({map:this.map,strokeWeight:1,strokeOpacity:0.5});b.setCenter(a);b.setRadius(this.options.radius);this.map.panTo(a)},_initializeMap:function(){this.map=new google.maps.Map(this.get(0),{disableDoubleClickZoom:true,scaleControl:false,zoomControl:true,mapTypeControl:false,streetViewControl:false,zoom:15,panControl:false,mapTypeId:google.maps.MapTypeId.ROADMAP,center:new google.maps.LatLng(this.options.position.latitude,
this.options.position.longitude)});var a=this;google.maps.event.addListener(this.map,"click",function(b){a._mapClicked(b)})}});function Schedules(a,b,c){this.api=a;this.element=b||$('<div class="schedules">');this.displays={};this.options=$.extend(c,this.defaults)}
$.extend(Schedules.prototype,{defaults:{displayClass:Stop},showStops:function(a,b){Log.message("At ",a.latitude,"(lat)",a.longitude+"(lng)");Log.verbose("Requesting stops");this.element.empty();this.displays={};var c=this;this.api.findStops(a,b,function(e){c.updateStops(e)})},updateStops:function(a){if(a.length==0)Log.message("No stops found within a",this.options.searchRadius,"meter radius");else{Log.verbose("Requesting schedule(s) for",a.length,"stop(s)");var b=this;a.map(function(c){this.api.getSchedule(c,
function(){b.updateStop(c);b.element.listview("refresh")})})}},updateStop:function(a){Log.verbose("Update for stop",a.code," with ",a.schedule.length,"entries");var b=this.displays[a.code];if(!b){b=new this.options.displayClass;this.displays[a.code]=b;this.element.append(b.element)}b.show(a)}});function Locator(a,b){this.options=$.extend(b||{},this.defaults);this.display=a}
$.extend(Locator.prototype,EventTarget,{defaults:{positionRetries:12,positionTimeout:500},locate:function(a){a=a||this.options.positionRetries;if(navigator.geolocation)if(a<0){Log.warn("Timeout while locating");this.display.text("Position not found")}else{Log.message("Locating ("+a+") retries left)");this.display.text("Locating "+"...".substring(0,3-a%3));var b=this;navigator.geolocation.getCurrentPosition(function(c){b._located(c.coords)},function(c){b._error(a,c)},{timeout:this.options.positionTimeout})}else{Log.warn("Geolocation service unavailable");
this.display.text("Location not selected")}},setLocation:function(a,b){this.dispatchEvent(new LocationEvent(a));if(b||!(google&&google.maps))this.display.text(a.toReadableString());else{var c=this;(new google.maps.Geocoder).geocode({location:new google.maps.LatLng(a.latitude,a.longitude)},function(e){if(e){a.addGeocodingResult(e);c.setLocation(a,true)}})}},_error:function(a,b){switch(b.code){case b.TIMEOUT:Log.verbose("Positioning timeout, retrying");this.locate(a-1);break;case b.POSITION_UNAVAILABLE:Log.error("Positioning unavailable");
this.display.text("Select location");break;case b.PERMISSION_DENIED:Log.error("Positioning not allowed");this.display.text("Positioning not allowed")}},_located:function(a){Log.verbose("Location received at "+a.latitude+","+a.longitude);this.setLocation(new Location(a.latitude,a.longitude))}});
