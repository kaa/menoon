<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script> -->
		<script src="static/jquery-1.3.2.min.js"></script>
		<script src="static/ReittiopasApi.js"></script>
		<script src="static/DummyApi.js"></script>
		<script src="static/Log.js"></script>
		<script src="static/jquery.jgrowl.js"></script>
		<link type="text/css" rel="stylesheet" href="static/style/screen.css"/>
		<style>
			#jGrowl { position: absolute; position: fixed; top: 0; text-align: right; right: 0 }
				#jGrowl div { background: white; opacity: 0.8 }
		</style>
	</head>
	<body>
		<div id="results"></div>
		<script type="text/javascript">
			// Parse querystring
			var queryString = {}
			window.location.search
				.replace(/^\?/,"")
				.split("&")
				.map(function(p){ 
					var pair =  p.split("=")
					queryString[pair[0]] = pair[1]
				})
		
			new Log(queryString["v"])
			
			var radius = 200
			if(queryString["d"]) {
				var api = new DummyApi()
			} else {
				var api = new ReittiopasApi("api.asp")
			}

			var elements = {}

			var fallbackPosition = { 
				coords: { latitude: "21.6", longitude: "63.4" } 
			}
			getPosition(positionUpdated,fallbackPosition)

			function getPosition(success,fallbackPosition) {
				var positionRetries = 0
				var gl = navigator.geolocation
				if(!gl) {
					Log.warn("Geolocation service unavailable, using fallback")
					success(fallbackPosition)
					return
				}
				Log.message("Requesting position");
				request();
				function request() {
					gl.getCurrentPosition( success, error, { timeout: 1000 });
				}
				function error(e) {
					if(e.code==e.TIMEOUT && ++positionRetries<3) {
						Log.verbose("Retrying position request")
						request()
					} else if(fallbackPosition) {
						Log.message("Using fallback position")
						success(fallbackPosition)
					} else {
						Log.error("Unable to get position")
					}
				}
			}
			
			function positionUpdated(position) {
				$("#results").empty();
				Log.message("At ",position.coords.latitude,"(lat)",position.coords.longitude+"(lng)")
				Log.verbose("Requesting stops");
				api.findStops(position,receivedStops)
			}

			function receivedStops(stops) {
				if(stops.length==0) {
					Log.message("No stops found within a",radius,"meter radius")
					return
				}
				Log.verbose("Requesting schedule(s) for",stops.length,"stop(s)")
				stops.map(function(stop){ 
					api.getSchedule(stop,displayStop)
				})
			}

			function displayStop(stop) {
				Log.verbose("Update for stop",stop.code," with ",stop.schedule.length,"entries")

				// Ensure display element exists
				var element = elements[stop.code]
				if(!element) {
					element = createDisplayTemplate()
					elements[stop.code] = element
					$("#results").append(element)
				}

				// Hide stop if no scheudled departures
				if(stop.schedule.length==0) {
					element.remove()
					delete elements[stop.code]
					return
				}

				// Add class for each transport type
				stop.schedule.map(function(entry){ 
					element.addClass(typeFromLine(entry.line)) 
				})

				// Update simple displays
				var displayName = stop.name||"Unknown"
				var displayAddress = (stop.address||"?")+" in "+(stop.city||"?")
				var displayDistance = (stop.distance||"?")+"m"
				element.find("h3 .name").text(displayName)
				element.find("h3 .address").text(displayAddress)
				element.find("h3 .dir").text(displayDistance)

				// Update lists
				displayDestinations(stop.schedule,element)
				displayImminent(stop.schedule,element)
				displaySchedule(stop.schedule,element)
			}
			function displayDestinations(schedule,element) {
				var destinations = {}
				schedule.map(function(entry){
					var d = destinations[entry.destination]||{}
					d[entry.line] = true
					destinations[entry.destination] = d
				})
				var list = element.find(".lines span").empty()
				var destinationSpacer = "";
				$.each(destinations,function(destination,lines){
					list.append(destinationSpacer)
					destinationSpacer = ", "
					var lineSpacer = "";
					var e = $("<strong>")
					e.append(destination+" (")
					$.each(lines,function(line){
						e.append(lineSpacer)
						lineSpacer = ", "
						e.append($("<span>").text(line))
					})
					e.append(")")
					list.append(e)
				})
			}
			function displaySchedule(schedule,element) {
				var list = element.find(".schedule ul").empty()
				schedule
					.filter(function(e){return e.time.getTime()>new Date().getTime()})
					.slice(0,10)
					.map(function(entry) {
						list.append($("<li>").append(
							$("<strong>").text(entry.time.toTimeString().substring(0,5)),
							" "+typeFromLine(entry.line)+" ",
							$("<strong>").text(entry.line),
							" to ",
							$("<strong>").text(entry.destination)
						))
				})
			}
			function displayImminent(schedule,element) {
				var list = element.find("ul.imminent").empty()
				schedule
					.filter(function(e){return e.time>new Date()})
					.slice(0,2)
					.map(function(entry){
						var delta = timeDiff(entry.time)
						delta = delta.getHours()*60+delta.getMinutes()
						list.append($(
							"<li><div>"+
								"<span class=\"time "+(delta>99?"long":"")+"\"><strong>"+delta+" min</strong></span> "+
								"<span class=\"departure\">No. "+entry.line+" at <em>"+entry.time.toTimeString().substring(0,5)+"</em></span>"+
								"<span class=\"line\">to "+entry.destination+"</span> "+
							"</div></li>"
						))
					})
			}
			function createDisplayTemplate() {
				var template = $(
						"<div class=\"stop\">"+
							"<h3><span class=\"name\">Unknown</span> <small>"+
								"<span class=\"address\"></span> "+
								"<span class=\"dir\"></span>"+
							"</small></h3>"+
							"<p class=\"lines\">Lines: <span>?</span></p>"+
							"<ul class=\"imminent\"></ul>"+
							"<div class=\"schedule\"><ul></ul></div>"+
						"</div>")
					template.find(".schedule ul").hide() // .click(function(){$(this).slideUp("fast")});
					template.find(".imminent").click(function(){$(this).parent().find(".schedule ul").slideToggle("fast")});
					return template;
			}
			function typeFromLine(line) {
				if(line=="metro") {
					return "metro"
				} else if(line=="lautta") {
					return "ferry"
				} else if(line.match(/^[a-zA-Z]$/)) {
					return "train"
				} else if(line.match(/^\d$/)) {
					return "tram"
				} else {
					return "bus"
				}
			}
			function timeDiff(a,b) {
				var delta = a.getTime()-(b||new Date()).getTime()
				return new Date(0,0,0,delta/1000/60/60,(delta/1000/60)%60,(delta/1000)%60)
			}
		</script>
	</body>
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-20530172-1']);
		_gaq.push(['_trackPageview']);
		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>
</html>