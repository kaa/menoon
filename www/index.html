<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
	</head>
	<body>
		<div id="results"></div>
		<script type="text/javascript">
			function error() {
				console.error(arguments)
				$(document.body).append("Error: "+Array.prototype.slice.call(arguments).join(" "))
			}
			function message() {
				console.log(arguments)
				$(document.body).append("<div>Message: "+Array.prototype.slice.call(arguments).join(" ")+"</div>")
			}
			function keys(hash) {
				var found = []
				for( var k in hash ) found.push(k);
				return found;
			}
			function fixName(name) {
				return name.replace(/(\w)?\(/, function($0,$1){return $1?$1+" (":$0})
			}
			
			var ReittiopasApi = function(apiUrl,apiUser,apiPass) {
				this.apiUrl = apiUrl
				this.apiUser = apiUser
				this.apiPass = apiPass
			}
			ReittiopasApi.prototype.findStops = function(position,success,error) {
				$.ajax({ 
					url: this.apiUrl,
					data: {
						"closest_stops": "1",
						"lat": position.coords.latitude,
						"lon": position.coords.longitude, 
						"radius": radius,
						"user": this.apiUser, "pass": this.apiPass
					}, 
					success: function(data) {
						success($(data)
							.find("[code]")
							.map(function(i,e){ 
								return {
									code: e.getAttribute("code"),
									lat: Number(e.getAttribute("lat")),
									lng: Number(e.getAttribute("lon")),
									distance: Number(e.getAttribute("dist"))
								}
							})
						)
					},
					error: function(request,status) {
						error("Unable to retrieve stops");
						console.error("Details", status, request.responseText)
					}
				});
			}
			ReittiopasApi.prototype.getSchedule = function(code,success,error) {
				$.ajax({
					url: this.apiUrl, 
					data: { "stop": stop.code, user: this.apiUser, pass: this.apiPass }, 
					success: function(data) {
						var lines = data.split("\n")
						var header = lines[0].split("|")
						stop.name = header[1]
						stop.address = header[2]
						stop.city = header[3]
						stop.schedule = lines
							.slice(1,lines.length-1)
							.map(this.parseScheduleLine)
						success(stop)
					},
					error: function(request,status) {
						error("Unable to retrieve schedule for stop "+code);
						console.error("Details", status, request.responseText)
					}
				})
			}
			ReittiopasApi.prototype.parseScheduleLine = function(line) {
				line = line.split("|")					
				return {
					time: this.parseTime(line[0]),
					line: line[1],
					destination: fixName(line[2]),
					code: line[3]
				}
			}
			ReittiopasApi.prototype.parseTime = function(time) {
				var ms = new Date().getTime()
				ms = ms-(ms%86400000);
				if(time.length==3) {
					ms += parseInt(time.substring(0,1))*60*60*1000 +
								parseInt(time.substring(1,3))*60*1000
				} else {
					ms += parseInt(time.substring(0,2))*60*60*1000 +
								parseInt(time.substring(2,4))*60*1000
				}
				return new Date(ms)
			}

			(function() {
				var radius = 200
				var api = new ReittiopasApi("api.asp","mioslabs","kaakaa")
				var elements = {}

				initialize();

				function initialize() {
					var gl = navigator.geolocation
					if(!gl) {
						error("Geolocation service unavailable")
						return
					}
					message("Requesting position");
					gl.getCurrentPosition(
						positionUpdated,
						function(error) {
							error("Unable to get position",error)
						}, { timeout: 2000 }
					)
				}

				function positionUpdated(position) {
					$("#results").empty();
					message("At ",position.coords.latitude,"(lat)",position.coords.longitude+"(lng)")
					message("Requesting stops");
					requestStops(position,receivedStops)
				}

				function requestStops(position,success) {
					api.findStops(position,success)
				}

				function receivedStops(stops) {
					if(stops.length==0) {
						message("No stops found within a",radius,"meter radius")
						return
					}
					message("Requesting schedule(s) for",stops.length,"stop(s)")
					stops.map(function(i,stop){ 
						requestStop(stop,displayStop)
					})
				}

				function requestStop(stop,success) {
					api.getSchedule(stop,successs)
				}

				function displayStop(stop) {
					var element = elements[stop.code]
					if(!element) {
						element = createDisplayTemplate()
						elements[stop.code] = element
						$("#results").append(element)
					}
					message("Update for stop",stop.code," with ",stop.schedule.length,"entries")
					if(stop.schedule.length==0) {
						element.remove()
						delete elements[stop.code]
						return
					}
					element.find("h3 span")
						.text(stop.name||"Unknown")
					element.find("h3 small")
						.text("("+
							(stop.address||"?")+" in "+
							(stop.city||"?")+", "+
							(stop.distance||"?")+"m)")
					displayDestinations(stop,element)
					displaySchedule(stop,element)
				}
				function displayDestinations(stop,element) {
					var destinations = {}
					stop.schedule.map(function(entry){
						var d = destinations[entry.destination]||{}
						d[entry.line] = true
						destinations[entry.destination] = d
					})
					var list = element.find("p.destinations>span").empty()
					var destinationSpacer = "";
					$.each(destinations,function(destination,lines){
						list.append(destinationSpacer)
						destinationSpacer = ", "
						var lineSpacer = "";
						var e = $("<strong>")
						e.append(destination+" ")
						$.each(lines,function(line){
							e.append(lineSpacer)
							lineSpacer = ", "
							e.append($("<span>").text(line))
						})
						list.append(e)
					})
				}
				function displaySchedule(stop,element) {
					var list = element.find("ul.schedule").empty()
					stop.schedule.map(function(entry) {
						list.append($("<li>").append(
							$("<strong>").text(entry.time.toTimeString().substring(0,5)),
							" "+typeFromLine(entry.line)+" ",
							$("<strong>").text(entry.line),
							" to ",
							$("<strong>").text(entry.destination)
						))
					})
				}
				function displayImminent(stop,element) {
					var list = element.find("ul.imminent").empty()
					stop.schedule.slice(0,2).each(function(i,entry){
						list.append($("<li>").append(
							$("<span>").text(entry.line),
							$("<strong>").text(entry.time),
							$("<em>").text(entry.time)
						))
					})
				}
				function createDisplayTemplate() {
					return $(
							"<div>"+
								"<h3><span>Unknown</span> <small></small></h3>"+
								"<p class=\"destinations\">Destination(s) <span>?</span></p>"+
								"<ul class=\"imminent\"></ul>"+
								"<ul class=\"schedule\"></ul>"+
							"</div>")
				}
				function typeFromLine(line) {
					if(line=="metro") {
						return "metro"
					} else if(line=="lautta") {
						return "ferry"
					} else if(line.match(/^[a-zA-Z]$/)) {
						return "train"
					} else if(line.match(/^\d$/)) {
						return "tram"
					} else {
						return "bus"
					}
				}
			})();
		</script>
	</body>
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-20530172-1']);
		_gaq.push(['_trackPageview']);
		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>
</html>